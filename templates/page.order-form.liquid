{% comment %}
Source: https://gist.github.com/carolineschnapp/9122054
Customized by: Michael X
{% endcomment %}

<!-- Header -->
<header class="collection-header">
  <div class="page-width">
    <div class="section-header text-center">
      <h1>Bulk Order Form</h1>
    </div>
  </div>
</header>

{% assign collection = collections.all %}

{% paginate collection.products by 100 %}

<div
  class="container"
  style="
    padding: 0 20px;
  "
>

  <form method="post">

    <!-- Page Content / Collection Description -->
    {% if template contains 'page' and page.content.size > 0 %}
      <div class="rte">
        {{ page.content }}
      </div>
    {% elsif collection.description.size > 0 %}
      <div class="rte">
        {{ collection.description }}
      </div>
    {% endif %}

    <!-- Product Table -->
    {% if collection.products_count > 0 %}
      <table class="custom-order-form">
        <thead>
          <tr
            style="
              display: grid;
              grid-template-columns: 100px 1fr 100px 200px 1fr 100px;
              grid-template-rows: 1fr;
            "
          >
            <th>Preview</th>
            <th>Name</th>
            <th>Price</th>
            <th>Engraving</th>
            <th class="product-header-donate">Donate</th>
            <th class="product-header-quantity">Quantity</th>
          </tr>
        </thead>
        <tbody>
        {% for product in collection.products %}
          {% if product.available %}
            {% for variant in product.variants %}
              {% if variant.available %}
                <tr
                  id="{{ variant.id }}"
                  class="variant-row {% cycle 'pure-table-odd', '' %}"
                  style="
                    display: grid;
                    grid-template-columns: 100px 1fr 100px 200px 1fr 100px;
                    grid-template-rows: 1fr;
                  "
                >
                  <td class="product-preview">
                    <a href="{{ variant.url | collection }}">
                      <img src="{{ variant.image | default: product.featured_image | img_url: 'small' }}" alt="{{ variant.title | escape }}" />
                    </a>
                  </td>
                  <td class="product-title">
                    <a href="{{ variant.url | collection }}">
                     {{ product.title }}{% unless variant.title contains 'Default' %} - {{ variant.title }}{% endunless %}{% unless variant.sku == blank %} - {{ variant.sku }}{% endunless %}
                    </a>
                  </td>
                  <td class="product-price">
                     {{ variant.price | money }}
                  </td>

                  <!-- Custom Engraving (optional) -->
                  {% if settings.engraving_enabled == 'yes' %}
                  <td class="product-engraving">
                    <p
                      class="line-item-property__field"
                      style="width: 100%;"
                    >
                      <input
                        type="text"
                        class="engraving custom-engraving"
                        style="padding: 10px; width: 100%;"
                      >
                    </p>
                  </td>
                  {% endif %}

                  <!-- Donate To SickKids (required) -->
                  {% if settings.donate_enabled == 'yes' %}
                  <td class="product-donate">
                    <p
                      class="line-item-property__field"
                      style="margin: 0;"
                    >
                      <label
                        style="
                          display: flex;
                          flex-direction: row;
                          align-items: center;
                        "
                      >
                        Plastic Wrap
                      </label>


                      <input
                        type="checkbox"
                        class="plastic"
                        name="usePlasticWrap"
                        value="usePlasticWrap"
                      >

                    </p>
                  </td>
                  {% endif %}

                  <td class="product-quantity">
                    <input
                      onfocus="this.select()"
                      class="quantity field"
                      min="0"
                      {% unless variant.inventory_management == blank or variant.inventory_policy == 'continue' %}
                        max="{{ variant.inventory_quantity }}"
                      {% endunless %}
                      type="text"
                      value="0"
                      tabindex="1"
                    />
                  </td>

                </tr>
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
        </tbody>
      </table>

      <!-- Actions -->
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: flex-end;
          padding: 20px;
        "
      >
        <input id="SubmitOrder" type="submit" value="Add to the cart" />
      </div>

    {% else %}
      <p>There are no products in this view.</p>
    {% endif %}

  </form>

</div>
{% endpaginate %}

{{'//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js' | script_tag}}
{{'api.jquery.js' | shopify_asset_url | script_tag}}

{% if collection.products_count > 0 %}
  <script>
  jQuery(function($) {
    $('table .quantity:first').focus();

    // validate - quantity doesn't exceed stock
    $('[max]').change(function() {
      var max = parseInt($(this).attr('max'), 10);
      var value = parseInt($(this).val(), 10) || 0;
      if (value > max) {
        alert('We only have ' + max + ' of this item in stock');
        $(this).val(max);
      }
    });

    // validate - engraving text doesn't exceed 5 char
    $('.custom-engraving').change(function() {
      let engravingText = $(this).val();
      if (engravingText.length > 5) {
        alert('Engravings are limited to 5 characters');
        $(this).val(engravingText.slice(0,5));
      }
    });

    $("#SubmitOrder").click(function (event) {
      event.preventDefault();
      event.stopPropagation();

      const variants = $( ".variant-row" ).toArray();
      const selectedVariants = variants.filter(variant =>
         parseInt($(variant).find( ".quantity" ).val()) > 0
      );

      const payloads = selectedVariants.map(variant => {
        return {
          id: parseInt($( variant).attr( "id" )),
          quantity: parseInt($(variant).find( ".quantity" ).val()),
          properties: {
            engraving: $(variant).find( ".engraving" ).val(),
            plastic: $(variant).find(".plastic")
                                       .prop('checked') == true
          }
        }
      });

      _moveAlong(payloads);
    });

    function _moveAlong(payloads) {
      if (payloads.length) { // requests in queue, process next request
        const request = payloads.shift();
        _addItem(request, payloads);
      } else { // queue empty, redirect to checkout
        window.location.href = "/checkout";
      }
    };

    function _addItem(request, payloads) {
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(request)
      }).then(response => response.json())
        .then(() => { _moveAlong(payloads) })
    };

  });
  </script>
{% endif %}